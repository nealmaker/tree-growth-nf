---
title: "Crown Density Model for Trees of the Northern Forest"
author: "Neal Maker"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    fig_caption: TRUE
    df_print: kable
---

```{r, setup, include=FALSE}
# knitr::opts_chunk$set(echo = T, error = T, warning = T, message = T,
#                       strip.white = F, tidy.opts = list(width.cutoff = 60))
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE,
                      message = FALSE)
```

# Goal

Create a relatively simple model of crown density to understand what affects it and to possibly incorporate into a new competition index

```{r region}
library("tidyverse")
library("lubridate")
library("english")
library("knitr")

# Define States & counties (FIPS codes) in Northern Forest region --------

states <- c("NY", "VT", "NH", "ME")

NY_counties <- c(75, 65, 49, 45, 89, 43, 35, 41, 33, 31, 19, 113)
VT_counties <- c(11, 19, 9, 7, 15, 5, 23, 1, 17, 13)
NH_counties <- c(7, 9, 3)
ME_counties <- c(17, 7, 25, 1, 11, 27, 9, 29, 19, 21, 3)
```

# Methods

FIA data were downloaded from the FIA DataMart^[https://apps.fs.usda.gov/fia/datamart/datamart.html] in the form of state-specific csv files, which were generated by the Forest Service from the FIA Oracle database tables. These data are current as of `r format(Sys.Date(), format = "%B %d, %Y")`. 

```{r fetch}
################################################################################
# Import FIA data
################################################################################

# Fetch FIA tree, growth, plot, & condition data for Northern Forest states
# and filter to keep only northern forest counties
# (this may take a while; ~140MB of downloads + reading)

temp <- tempfile()

for(state in states){
  download.file(paste("https://apps.fs.usda.gov/fia/datamart/CSV/",
                      state, "_TREE.zip", sep = ""),
                temp, mode = "wb")
  unzip(temp, paste(state, "_TREE.csv", sep = ""))
}

TREE <- lapply(states, function(x){
  read.csv(paste(x, "_TREE.csv", sep = ""), header = T) %>%
    filter(COUNTYCD %in% eval(as.name(paste(x, "_counties", sep = ""))),
           DIAHTCD == 1) %>% # excludes seedlings measured at root collar
    select(CN, PLT_CN, SUBP, CONDID, DIA, SPCD, STATUSCD,
           MORTYR, CR, CCLCD, TREECLCD, HT, HTCD, CDENCD, TRANSCD) %>%
    mutate(ba_ac = if_else(DIA >= 5,
                           # poles & larger from 24' radius subplots
                           # saplings from 6.8' radius microplots
                           0.005454*DIA^2*(43560/(pi*24^2)),  
                           0.005454*DIA^2*(43560/(pi*6.8^2))))
})

for(state in states){
  download.file(paste("https://apps.fs.usda.gov/fia/datamart/CSV/", state,
                      "_PLOT.zip", sep = ""),
                temp, mode = "wb")
  unzip(temp, paste(state, "_PLOT.csv", sep = ""))
}

PLOT <- lapply(states, function(x){
  read.csv(paste(x, "_PLOT.csv", sep = ""), header = T) %>%
    filter(COUNTYCD %in% eval(as.name(paste(x, "_counties", sep = "")))) %>%
    select(CN, DESIGNCD, LAT, LON, ELEV) %>%
    rename(PLT_CN = CN)
})


for(state in states){
  download.file(paste("https://apps.fs.usda.gov/fia/datamart/CSV/", state,
                      "_COND.zip", sep = ""),
                temp, mode = "wb")
  unzip(temp, paste(state, "_COND.csv", sep = ""))
}

COND <- lapply(states, function(x){
  read.csv(paste(x, "_COND.csv", sep = ""), header = T) %>%
    filter(COUNTYCD %in% eval(as.name(paste(x, "_counties", sep = "")))) %>%
    select(PLT_CN, CONDID, FORTYPCD, ALSTKCD, SITECLCD,
           PHYSCLCD, SLOPE, ASPECT)
})


# Combine states' data

nf_trees <- do.call(rbind, TREE)
nf_plots <- do.call(rbind, PLOT)
nf_conds <- do.call(rbind, COND)

# delete temporary objects and downloaded files

unlink(temp)

remove(TREE, PLOT, COND, temp, state)

for(state in states){
  file.remove(paste(state, "_TREE.csv", sep = ""))
  file.remove(paste(state, "_PLOT.csv", sep = ""))
  file.remove(paste(state, "_COND.csv", sep = ""))
}
```

```{r sppNames}
################################################################################
# Group species
################################################################################

# Make names and factor levels more intuitive ------------------------------

species_codes <-
  c(12, 43, 68, 70, 71, 91, 94, 95, 96, 97, 105, 123, 125, 126, 129,
    130, 136, 202, 221, 241, 261, 310, 313, 314, 315, 316, 317, 318,
    319, 320, 331, 341, 355, 356, 357, 367, 370, 371, 372, 373, 375,
    379, 391, 400, 402, 403, 407, 409, 421, 462, 491, 500, 531, 540,
    541, 543, 544, 546, 552, 601, 602, 621, 651, 655, 660, 661, 663,
    680, 693, 701, 712, 731, 741, 742, 743, 744, 746, 760, 761, 762,
    763, 764, 771, 802, 804, 806, 816, 823, 832, 833, 837, 901, 920,
    922, 923, 926, 934, 935, 936, 937, 950, 951, 970, 972, 975, 977,
    999)

species <-
  c("fir", "other softwood", "cedar", "tamarack", "tamarack",
    "norway spruce", "spruce", "spruce", "spruce", "spruce", "other softwood",
    "other softwood", "red pine", "other softwood", "white pine", "scots pine",
    "other softwood", "other softwood", "other softwood", "cedar", "hemlock",
    "other hardwood", "soft maple", "hard maple", "striped maple", "soft maple",
    "soft maple", "hard maple", "other hardwood", "hard maple",
    "other hardwood", "other hardwood", "other hardwood", "other hardwood",
    "other hardwood", "other hardwood", "other hardwood", "yellow birch",
    "other hardwood", "other hardwood", "paper birch", "other hardwood",
    "other hardwood", "hickory", "hickory", "hickory", "hickory", "hickory",
    "other hardwood", "other hardwood", "other hardwood", "other hardwood",
    "beech", "ash", "ash", "ash", "ash", "ash", "other hardwood", "butternut",
    "other hardwood", "other hardwood", "other hardwood", "other hardwood",
    "other hardwood", "other hardwood", "other hardwood", "other hardwood",
    "other hardwood", "hophornbeam", "other hardwood", "other hardwood",
    "aspen", "cottonwood", "aspen", "cottonwood", "aspen", "other hardwood",
    "other hardwood", "black cherry", "other hardwood", "other hardwood",
    "other hardwood", "white oak", "white oak", "red oak", "white oak",
    "white oak", "white oak", "red oak", "red oak", "other hardwood",
    "other hardwood", "other hardwood", "other hardwood", "other hardwood",
    "other hardwood", "other hardwood", "other hardwood", "other hardwood",
    "basswood", "basswood", "elm", "elm", "elm", "elm", "other hardwood")

names(species) <- as.character(species_codes)

nf_trees$SPCD <- factor(unname(species[as.character(nf_trees$SPCD)]),
                     levels = levels(factor(species))) # standardize levels
```


```{r before_and_after}
################################################################################
# Combine FIA tables & reformat
################################################################################

# get before and after data and remeasurement period for each tree and -----
# add initial cond and plot data -------------------------------------------

nf_fia <- nf_trees %>%
  left_join(nf_plots, by = "PLT_CN") %>%
  left_join(nf_conds, by = c("PLT_CN", "CONDID")) %>%
  rename(cn = CN,
         plt_cn = PLT_CN,
         condid = CONDID,
         spp = SPCD,
         dbh = DIA,
         statuscd = STATUSCD,
         mortyr = MORTYR,
         cr = CR,
         crown_class = CCLCD,
         tree_class = TREECLCD,
         crown_density = CDENCD,
         fol_transpar = TRANSCD,
         ht = HT,
         forest_type = FORTYPCD,
         stocking = ALSTKCD,
         site_class = SITECLCD,
         landscape = PHYSCLCD,
         slope = SLOPE,
         aspect = ASPECT,
         designcd = DESIGNCD,
         lat = LAT,
         lon = LON,
         elev = ELEV)


remove(nf_conds, nf_plots, nf_trees, states,
       VT_counties, NH_counties, NY_counties, ME_counties, state,
       temp, species, species_codes)
```

```{r categorical_levels}
################################################################################
# Make names and factor levels more intuitive
################################################################################

# Forest types -----------------------------------------------------------------

forest_type_codes <-
  c(101, 102, 103, 104, 105, 121, 122, 123, 124, 125, 126, 127,
    167, 171, 381, 384, 385, 401, 402, 409, 503, 505, 509, 512,
    513, 515, 516, 517, 519, 520, 701, 702, 703, 704, 705, 706,
    707, 708, 709, 801, 802, 805, 809, 901, 902, 903, 904, 905,
    962, 995, 999)

forest_types <-
  c("Red pine", "Red pine", "White pine", "Mixed softwood", "Hemlock",
    "Spruce-fir", "Spruce-fir", "Spruce-fir", "Spruce-fir", "Spruce-fir",
    "Larch", "Cedar", "Mixed softwood", "Mixed softwood", "Scots pine",
    "Norway spruce", "Larch", "Pine-hardwood", "Mixedwood",
    "Pine-hardwood", "Oak-hickory", "Oak-hickory", "Oak-hickory",
    "Transition hardwood", "Transition hardwood", "Oak-hickory",
    "Transition hardwood", "Transition hardwood", "Northern hardwood",
    "Northern hardwood", "Northern hardwood", "Transition hardwood",
    "Cottonwood", "Other", "Other", "Other", "Northern hardwood",
    "Northern hardwood", "Cottonwood", "Northern hardwood",
    "Northern hardwood", "Northern hardwood", "Northern hardwood",
    "Northern hardwood", "Northern hardwood", "Northern hardwood",
    "Northern hardwood", "Northern hardwood", "Other", "Other",
    "Nonstocked")

names(forest_types) <- as.character(forest_type_codes)

nf_fia$forest_type <-
  factor(unname(forest_types[as.character(nf_fia$forest_type)]),
         levels = levels(factor(forest_types)))


# Landscapes -------------------------------------------------------------------

landscape_codes <- # add 19 & 33
  c(11, 12, 13, 19, 21, 22, 23, 24, 25, 29, 31, 32, 33, 34, 39)

landscapes <-
  c("dry tops", "dry slopes", "deep sands", "other xeric", "flatwoods",
    "rolling uplands", "moist slopes & coves", "narrow floodplains/bottomlands",
    "broad floodplains/bottomlands", "other mesic", "swamps/bogs",
    "small drains", "small drains", "beaver ponds", "other hydric")

names(landscapes) <- as.character(landscape_codes)

nf_fia$landscape <- factor(unname(landscapes[as.character(nf_fia$landscape)]),
                           levels = levels(factor(landscapes)))
```

# Crown Density Relationships

For crown density, FIA envisions an idealized crown starting at the bottom of the uncompacted live crown and extending symetrically to top, then estimates the amount of material blocking light in that idealized crown. It would be a good complement to uncompacted crown ratio and height derived crown area to estimate total light transmittence. For foliar transparancy, they only look at areas that are foliated (exculding areas of dieback and holes in the crown) and estimate the transparency (opposite of density) excluding branches. It's maybe a better complement to crown areas derived from compacted crown ratio (which we have here), but it excludes light blocking from branches.

```{r denSpp}
nf_fia %>% filter(!is.na(crown_density)) %>% 
  mutate(spp = reorder(spp, crown_density, mean)) %>% 
  ggplot(aes(crown_density, spp)) + geom_boxplot()
```

```{r denDbh}
nf_fia %>% filter(!is.na(crown_density)) %>% 
  ggplot(aes(dbh, crown_density)) + geom_jitter(height = 2.5, width =0, alpha = .05) +
  geom_smooth()
```

```{r denCr}
nf_fia %>% filter(!is.na(crown_density)) %>% 
  ggplot(aes(cr, crown_density)) + geom_jitter(height = 2.5, width =5, alpha = .05) +
  geom_smooth()
```

```{r denHt}
nf_fia %>% filter(!is.na(crown_density)) %>% 
  ggplot(aes(ht, crown_density)) + geom_jitter(height = 2.5, width =0, alpha = .05) +
  geom_smooth()
```

```{r denCclass}
nf_fia %>% filter(!is.na(crown_density)) %>%  
  ggplot(aes(crown_density, as.factor(crown_class))) + geom_boxplot() 
```

```{r denElev}
nf_fia %>% filter(!is.na(crown_density)) %>% 
  ggplot(aes(elev, crown_density)) + geom_jitter(height = 2.5, width =0, alpha = .05) +
  geom_smooth()
```

```{r denLat}
nf_fia %>% filter(!is.na(crown_density)) %>% 
  ggplot(aes(lat, crown_density)) + geom_jitter(height = 2.5, width =0, alpha = .05) +
  geom_smooth()
```

```{r denLon}
nf_fia %>% filter(!is.na(crown_density)) %>% 
  ggplot(aes(lon, crown_density)) + geom_jitter(height = 2.5, width =0, alpha = .05) +
  geom_smooth()
```

```{r denSite}
nf_fia %>% filter(!is.na(crown_density)) %>%  
  ggplot(aes(crown_density, as.factor(site_class))) + geom_boxplot() 
```

```{r denForType}
nf_fia %>% filter(!is.na(crown_density)) %>%  
  mutate(forest_type = reorder(forest_type, crown_density, mean)) %>% 
  ggplot(aes(crown_density, forest_type)) + geom_boxplot() 
```

```{r denStocking}
nf_fia %>% filter(!is.na(crown_density)) %>%  
  ggplot(aes(crown_density, as.factor(stocking))) + geom_boxplot() 
```

```{r denLand}
nf_fia %>% filter(!is.na(crown_density)) %>%  
  mutate(landscape = reorder(landscape, crown_density, mean)) %>% 
  ggplot(aes(crown_density, landscape)) + geom_boxplot() 
```

```{r denSlope}
nf_fia %>% filter(!is.na(crown_density)) %>% 
  ggplot(aes(slope, crown_density)) + geom_jitter(height = 2.5, width =0, alpha = .05) +
  geom_smooth()
```

```{r denAspect}
nf_fia %>% filter(!is.na(crown_density)) %>% 
  ggplot(aes(aspect, crown_density)) + geom_jitter(height = 2.5, width =0, alpha = .05) +
  geom_smooth()
```